# Памятка для Нового Чата – Реализация Визуальной Оргсхемы Компании

**1. Глобальная Цель:**
Создать интерактивную страницу "Визуальная схема" по адресу `/admin/structure/chart` (или `/structure/chart`), которая будет отображать актуальную организационную и управленческую структуру компании.

**2. Ключевая Концепция (Основано на `docs/features/positions_and_orgchart_vision.md`):**
*   **НЕ ПУТАТЬ:**
    *   **Должность (`Position`):** Роль (Инженер, Директор).
    *   **Атрибут Должности (`Position.attribute`):** Уровень/важность/доступ (Специалист, Руководитель отдела, Директор). **Не определяет иерархию.** Используется для **визуального стиля** узлов на схеме.
    *   **Принадлежность к Подразделению (`Position.division_id`, `Position.section_id`):** Базовая привязка должности к "родному" отделу/департаменту (важно для НЕ-топовых должностей). Используется для **визуальной группировки** на схеме.
    *   **Функциональная Связь (`FunctionalRelation`):** **ГЛАВНЫЙ ЭЛЕМЕНТ!** Определяет реальные связи: кто кому подчиняется (Должность -> Должность), кто чем управляет (Должность -> Подразделение/Отдел/Функция). **Именно на основе этих связей должна строиться иерархия на схеме.**
*   **Гибкость:** Схема должна уметь отображать сложные, в т.ч. матричные, структуры благодаря `FunctionalRelation`.

**3. Текущий Статус и Проблемы:**
*   Создана базовая страница `frontend/src/pages/StructureChartPage.tsx`.
*   Добавлен роут `/admin/structure/chart`.
*   **Расхождение с Концепцией:** Изначальный план был использовать `OrganizationGraph` из `@ant-design/charts` и строить дерево по `parent_id` у `Organizations` и `Divisions`. **ЭТО НЕВЕРНО!** Это противоречит согласованной концепции, основанной на `FunctionalRelation` и Должностях.
*   **Новая Попытка (Судя по коду `StructureChartPage.tsx`):** Похоже, была начата работа по переходу на библиотеку **`react-flow`** (или аналог) и использование **`dagre.js`** для автоматической раскладки узлов. Этот подход **гораздо лучше** соответствует концепции, но реализация в файле, вероятно, не завершена или содержит ошибки.
*   **Бэкенд:** CRUD для базовых сущностей (Org, Div, Sec, Pos, Staff) реализован. **НО!** Сущность `FunctionalRelation` и её API **НЕ РЕАЛИЗОВАНЫ** (согласно `MAIN_CHECKLIST.md`).

**4. Необходимые Данные для *Правильной* Схемы:**
*   **Обязательно:**
    *   Список Должностей (`GET /positions`) - включая поле `attribute`.
    *   Список Функциональных Связей (`GET /functional-relations`) - все связи типа "подчинение" (Должность -> Должность).
*   **Желательно (для Визуализации):**
    *   Список Подразделений (`GET /divisions`).
    *   Список Отделов (`GET /sections`).
    *   (Опционально) Список Сотрудников (`GET /staff`) и их связь с Должностями (через `StaffPosition`, которую тоже надо будет реализовать), если хотим показывать ФИО на узлах должностей.

**5. Первоочередные Задачи (Блокеры для Схемы):**
*   **Бэкенд:**
    *   **Реализовать Сущность `FunctionalRelation`:**
        *   Добавить таблицу `functional_relations` в БД (см. `complete_schema.py`, она там вроде уже есть, но проверить!).
        *   Создать Pydantic модели (`FunctionalRelationBase`, `FunctionalRelationCreate`, `FunctionalRelation`).
        *   **Реализовать CRUD API:** `POST /functional-relations`, `GET /functional-relations` (с фильтрацией по типу связи, по ID менеджера/подчиненного), `GET /functional-relations/{id}`, `PUT /functional-relations/{id}`, `DELETE /functional-relations/{id}`.
    *   **Должности:** Убедиться, что `GET /positions` и `GET /positions/{id}` возвращают поле `attribute` для каждой должности.
*   **Бэкенд (Следующий этап):** Реализовать связь Сотрудник <-> Должность (таблица `staff_positions` и её API), если хотим видеть людей на схеме.

**6. Задачи для Фронтенда (Страница `StructureChartPage.tsx`):**
*   **Библиотека:** Окончательно выбрать и настроить `react-flow` (или аналог, но `react-flow` уже в коде).
*   **Загрузка Данных:** Изменить `fetchData`, чтобы загружать `Positions` и `FunctionalRelation` (вместо/вдобавок к Orgs/Divisions).
*   **Трансформация Данных:** Написать/доработать функцию (`transformDataToFlow`), которая преобразует список Должностей в узлы (`nodes`) для `react-flow`, а список `FunctionalRelation` (только подчинения Должность->Должность) - в рёбра (`edges`).
*   **Авто-раскладка:** Интегрировать/доработать `dagre.js` (`getLayoutedElements`), чтобы он расставлял узлы-должности по иерархии, заданной рёбрами (связями подчинения).
*   **Стилизация Узлов:** Настроить внешний вид узлов (`nodeStyle`) в зависимости от значения `position.attribute`.
*   **Визуальная Группировка:** Реализовать отображение Подразделений/Отделов как фоновых контейнеров или групп (используя данные `position.division_id`/`section_id`), внутри которых будут располагаться соответствующие должности. `react-flow` поддерживает subflows или кастомные узлы-контейнеры.
*   **Интерактивность:** Добавить базовые элементы управления (`Controls`, `MiniMap`, `Background`), зум, перетаскивание.

**7. Что Обсудить в Новом Чате:**
*   Стратегия реализации CRUD API для `FunctionalRelation` на бэкенде.
*   Детали реализации `transformDataToFlow` и `getLayoutedElements` на фронте.
*   Способ визуальной группировки должностей по подразделениям в `react-flow`.
*   Нужно ли сразу показывать сотрудников на схеме, или пока ограничимся должностями? 