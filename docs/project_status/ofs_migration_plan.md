# План миграции архитектуры OFS на гибкую модель

## Выявленные проблемы текущей архитектуры

В существующей архитектуре `full_api.py` имеются жесткие ограничения, не соответствующие реальным бизнес-требованиям:

1. **Жесткая привязка сотрудников к юр.лицам**: Сотрудники могут быть связаны только с LEGAL_ENTITY, но не с LOCATION
2. **Ограничения на размещение локаций**: Локации могут быть только внутри юр.лица или холдинга
3. **Один сотрудник - одна должность**: Нет возможности для одного сотрудника иметь несколько должностей или функций
4. **Отсутствие временных назначений**: Нет механизма временного перевода сотрудника на другую должность или в другую локацию

## Целевая архитектура

Преобразование иерархической модели в графовую структуру, где:

1. **Базовые сущности** остаются неизменными:
   - Organizations (HOLDING, LEGAL_ENTITY, LOCATION)
   - Divisions (Департаменты/отделы)
   - Sections (Подотделы)
   - Functions (Функции)
   - Positions (Должности)
   - Staff (Сотрудники)

2. **Связующие таблицы** обеспечивают гибкие отношения:
   - `staff_positions` - связь между сотрудниками и должностями
   - `staff_locations` - физическое размещение сотрудников
   - `staff_functions` - функции, выполняемые сотрудниками
   - `functional_relations` - различные типы подчинения

3. **Временные параметры** для всех назначений:
   - Даты начала и окончания
   - Признак "текущий"/"основной"
   - Процент занятости

4. **История изменений** для всех связей

## Чек-лист изменений

### 1. Модификация базы данных

- [ ] **Создать новые таблицы**:
  - [ ] `staff_positions` (многие ко многим между Staff и Position)
    ```sql
    CREATE TABLE staff_positions (
        id INTEGER PRIMARY KEY,
        staff_id INTEGER REFERENCES staff(id),
        position_id INTEGER REFERENCES positions(id),
        division_id INTEGER REFERENCES divisions(id),
        is_primary BOOLEAN DEFAULT TRUE,
        date_from DATE,
        date_to DATE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    ```
  
  - [ ] `staff_locations` (многие ко многим между Staff и Location)
    ```sql
    CREATE TABLE staff_locations (
        id INTEGER PRIMARY KEY,
        staff_id INTEGER REFERENCES staff(id),
        location_id INTEGER REFERENCES organizations(id),
        is_current BOOLEAN DEFAULT TRUE,
        date_from DATE,
        date_to DATE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CHECK (EXISTS (SELECT 1 FROM organizations WHERE id = location_id AND org_type = 'location'))
    );
    ```
  
  - [ ] `staff_functions` (многие ко многим между Staff и Function)
    ```sql
    CREATE TABLE staff_functions (
        id INTEGER PRIMARY KEY,
        staff_id INTEGER REFERENCES staff(id),
        function_id INTEGER REFERENCES functions(id),
        commitment_percent INTEGER DEFAULT 100,
        is_primary BOOLEAN DEFAULT TRUE,
        date_from DATE,
        date_to DATE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    ```

- [ ] **Модифицировать существующие таблицы**:
  - [ ] Добавить в `staff` поле `primary_organization_id` (для юридической принадлежности)
  - [ ] Убрать ограничения в существующих внешних ключах
  - [ ] Добавить индексы для ускорения запросов

- [ ] **Создать триггеры**:
  - [ ] Для автоматического обновления полей `updated_at`
  - [ ] Для проверки корректности дат (date_from < date_to)
  - [ ] Для обеспечения консистентности (не более одного is_primary = TRUE для каждого сотрудника)

### 2. Модификация API (full_api.py)

- [ ] **Убрать жесткие валидации**:
  - [ ] Валидация, запрещающая связывать сотрудника с локацией
  - [ ] Ограничения на создание локаций внутри локаций (если это допустимо бизнес-логикой)
  - [ ] Другие ограничения, не соответствующие гибкой модели

- [ ] **Добавить новые модели Pydantic**:
  - [ ] `StaffPositionBase`, `StaffPositionCreate`, `StaffPosition`
  - [ ] `StaffLocationBase`, `StaffLocationCreate`, `StaffLocation`
  - [ ] `StaffFunctionBase`, `StaffFunctionCreate`, `StaffFunction`

- [ ] **Разработать новые эндпоинты**:
  - [ ] CRUD для `staff_positions`
    ```python
    @app.post("/staff-positions/", response_model=StaffPosition)
    @app.get("/staff-positions/", response_model=List[StaffPosition])
    @app.get("/staff-positions/{id}", response_model=StaffPosition)
    @app.put("/staff-positions/{id}", response_model=StaffPosition)
    @app.delete("/staff-positions/{id}", response_model=dict)
    ```
  
  - [ ] CRUD для `staff_locations`
    ```python
    @app.post("/staff-locations/", response_model=StaffLocation)
    @app.get("/staff-locations/", response_model=List[StaffLocation])
    @app.get("/staff-locations/{id}", response_model=StaffLocation)
    @app.put("/staff-locations/{id}", response_model=StaffLocation)
    @app.delete("/staff-locations/{id}", response_model=dict)
    ```
  
  - [ ] CRUD для `staff_functions`
    ```python
    @app.post("/staff-functions/", response_model=StaffFunction)
    @app.get("/staff-functions/", response_model=List[StaffFunction])
    @app.get("/staff-functions/{id}", response_model=StaffFunction)
    @app.put("/staff-functions/{id}", response_model=StaffFunction)
    @app.delete("/staff-functions/{id}", response_model=dict)
    ```

- [ ] **Модифицировать существующие эндпоинты**:
  - [ ] `/staff/` для включения связанных данных
  - [ ] `/positions/` для включения связанных сотрудников
  - [ ] `/organizations/` для правильного отображения локаций и связанных сотрудников

- [ ] **Добавить специальные эндпоинты для часто используемых операций**:
  - [ ] Быстрое переключение между должностями
    ```python
    @app.post("/staff/{staff_id}/switch-position/{position_id}")
    ```
  - [ ] Временный перевод на другую локацию
    ```python
    @app.post("/staff/{staff_id}/assign-location/{location_id}")
    ```
  - [ ] Назначение дополнительной функции
    ```python
    @app.post("/staff/{staff_id}/add-function/{function_id}")
    ```

### 3. Миграция данных

- [ ] **Разработать скрипт миграции**:
  - [ ] Сохранить текущие связи сотрудников с организациями в новую таблицу `staff_locations`
  - [ ] Извлечь информацию о должностях из существующих данных и заполнить `staff_positions`
  - [ ] Определить основные функции из должностей и заполнить `staff_functions`

- [ ] **Проверить целостность данных после миграции**:
  - [ ] Убедиться, что все сотрудники имеют хотя бы одну связь в каждой таблице
  - [ ] Проверить корректность флагов is_primary/is_current
  - [ ] Проверить консистентность дат

### 4. Обновление фронтенда

- [ ] **Доработать компоненты**:
  - [ ] Карточка сотрудника с отображением множественных должностей/локаций
  - [ ] Интерфейс быстрого переключения между должностями/локациями
  - [ ] Временная шкала для визуализации истории назначений

- [ ] **Модифицировать формы**:
  - [ ] Форма создания/редактирования сотрудника с возможностью указания нескольких должностей
  - [ ] Форма назначения временной должности или локации
  - [ ] Интерфейс управления процентом загрузки по разным функциям

- [ ] **Разработать новые представления**:
  - [ ] Матрица функций и сотрудников
  - [ ] Визуализация карты размещения сотрудников по локациям
  - [ ] Таймлайн изменений для каждого сотрудника

### 5. Обновление документации

- [ ] **Обновить документацию API**:
  - [ ] Описать новые эндпоинты в Swagger/OpenAPI
  - [ ] Добавить примеры запросов и ответов

- [ ] **Обновить документацию для разработчиков**:
  - [ ] Описать новую архитектуру и принципы работы с ней
  - [ ] Добавить руководство по миграции с предыдущей версии

- [ ] **Обновить пользовательскую документацию**:
  - [ ] Инструкция по управлению множественными назначениями
  - [ ] Руководство по временным назначениям и перемещениям

## Приоритизация задач

### Этап 1: Минимальные изменения для базовой гибкости
1. Убрать жесткие валидации в API
2. Создать базовые таблицы staff_positions и staff_locations
3. Реализовать базовые эндпоинты для новых таблиц
4. Обновить карточку сотрудника во фронтенде

### Этап 2: Полноценный переход на гибкую модель
1. Добавить все остальные таблицы и связи
2. Реализовать расширенные функциональности (временные назначения, история)
3. Доработать все представления фронтенда
4. Разработать полную документацию

### Этап 3: Расширенные возможности и интеграции
1. Разработать интеграцию с телеграм-ботом
2. Подготовить API для ИИ-аналитики
3. Интегрировать с другими модулями ERP

## Оценка трудозатрат

| Задача | Примерное время (человеко-дни) |
|--------|-------------------------------|
| Модификация БД | 2-3 |
| Модификация API | 5-7 |
| Миграция данных | 1-2 |
| Обновление фронтенда | 7-10 |
| Обновление документации | 2-3 |
| **Итого** | **17-25** |

## Риски и их митигация

| Риск | Вероятность | Последствия | Митигация |
|------|-------------|-------------|-----------|
| Несовместимость с существующими данными | Средняя | Серьезные | Тщательное тестирование на копии продуктивных данных |
| Регрессии в существующем функционале | Высокая | Серьезные | Комплексное тестирование после каждого этапа |
| Увеличение сложности запросов к БД | Высокая | Средние | Оптимизация индексов и запросов, денормализация данных при необходимости |
| Сложности в понимании новой модели пользователями | Средняя | Средние | Подробная документация и интуитивно понятный интерфейс |

## Заключение

Предложенные изменения позволят трансформировать текущую жесткую иерархическую структуру в гибкую графовую модель, которая соответствует реальным бизнес-процессам компании. Такая архитектура станет надежной основой для будущей ERP-системы и обеспечит возможности для:

1. Гибкого управления кадрами в различных должностях и локациях
2. Временных назначений и перемещений сотрудников
3. Матричного управления с множественным подчинением
4. Аналитики и оптимизации с помощью ИИ

Реализация данного плана потребует существенных изменений как в бэкенде, так и во фронтенде, но результат будет полностью соответствовать бизнес-требованиям и обеспечит необходимую гибкость системы. 