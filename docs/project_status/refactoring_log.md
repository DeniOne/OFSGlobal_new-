# Лог рефакторинга архитектуры OFS Global

## Общий план

Выполняем миграцию архитектуры согласно [плану](docs/ofs_migration_plan.md), трансформируя жесткую иерархическую структуру в гибкую графовую модель.

## Этап 1: Подготовка схемы базы данных (2023-03-31)

- [x] Обновлена схема `staff_positions` - добавлено поле `division_id`
- [x] Создана новая таблица `staff_locations` для связи сотрудников с физическими локациями
- [x] Обновлена схема `staff_functions` - добавлены поля `commitment_percent`, `date_from`, `date_to`, `is_primary`
- [x] Обновлена схема `staff` - добавлено поле `primary_organization_id`, сделано необязательным поле `organization_id`

## ВАЖНО: Отказ от костылей и полный перезапуск (2023-03-31)

После проверки, выявлено, что поле organization_id в таблице staff по-прежнему обязательно (NOT NULL). 
Решение: полная переделка базы данных с нуля, так как:
- SQLite не позволяет прямо менять атрибут NOT NULL
- База тестовая, данные не критичны
- Чистое решение лучше, чем костыли с поддержкой обязательных полей

План действий:
1. Создание новой базы с полностью корректной схемой
2. Использование резервных мест в таблицах для будущих расширений (extra_field1, extra_field2...)
3. Загрузка тестовых данных в новую структуру

## Этап 2: Обновление API (2023-03-31)

- [x] Добавлены модели Pydantic для новых таблиц (`StaffLocationBase`, `StaffLocationCreate`, `StaffLocation`)
- [x] Обновлены модели для связи сотрудников и функций (`StaffFunctionBase`, `StaffFunctionCreate`, `StaffFunction`)
- [x] Обновлена модель `StaffBase` - добавлено поле `primary_organization_id`
- [x] Созданы CRUD-эндпоинты для `staff_locations` (`GET`, `POST`, `PUT`, `DELETE`)
- [x] Обновлены эндпоинты для `staff_functions` с учетом новых полей
- [x] Обновлены эндпоинты для `staff`, удалены валидации, привязывающие сотрудников только к юридическим лицам

## Этап 3: Миграция данных (2023-03-31)

- [x] Создан скрипт `migrate_data.py` для миграции данных из старой схемы в новую
- [ ] Протестирован скрипт миграции на тестовых данных
- [ ] Выполнена миграция на реальных данных

## Этап 4: Обновление фронтенда

- [ ] Обновлена карточка сотрудника для отображения множественных должностей и локаций
- [ ] Обновлена форма создания/редактирования сотрудника 
- [ ] Добавлены интерфейсы для управления локациями сотрудника
- [ ] Добавлены интерфейсы для назначения временных должностей

## Проблемы и решения

1. **Проблема**: Жесткая привязка сотрудников к юридическим лицам.
   **Решение**: Сделано поле `organization_id` необязательным и добавлено новое поле `primary_organization_id` для указания основного юридического лица.

2. **Проблема**: Отсутствие возможности иметь несколько должностей.
   **Решение**: Создана таблица `staff_positions` для связи многие-ко-многим между сотрудниками и должностями.

3. **Проблема**: Невозможность перемещения сотрудников между локациями.
   **Решение**: Создана таблица `staff_locations` для отслеживания физического размещения сотрудников.

4. **Проблема**: Отсутствие временных параметров для назначений.
   **Решение**: Добавлены поля `date_from` и `date_to` во все связующие таблицы для указания периода действия.

## Следующие шаги

1. Провести тестирование миграции данных на тестовых данных
2. Обновить пользовательский интерфейс для поддержки новых возможностей
3. Добавить дополнительные запросы API для удобной работы с новой структурой
4. Разработать представления для визуализации множественных связей сотрудников 